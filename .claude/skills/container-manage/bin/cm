#!/usr/bin/env bash
# Container Management Tool (cm)
# Manages container initialization and Tmux sessions for univers containers

set -e

# Color codes
RED='\\033[0;31m'
GREEN='\\033[0;32m'
YELLOW='\\033[1;33m'
BLUE='\\033[0;34m'
CYAN='\\033[0;36m'
NC='\\033[0m'

# Ensure ~/.local/bin is in PATH for tmux scripts
export PATH="$HOME/.local/bin:$PATH"

# Logging functions
log_info() {
    echo -e "${BLUE}â„¹ï¸  $1${NC}"
}

log_success() {
    echo -e "${GREEN}âœ… $1${NC}"
}

log_warning() {
    echo -e "${YELLOW}âš ï¸  $1${NC}"
}

log_error() {
    echo -e "${RED}âŒ $1${NC}"
}

log_step() {
    echo -e "${CYAN}â–¶ $1${NC}"
}

# Print help
print_help() {
    cat << 'HELP'
Container Management Tool (cm)

Usage: cm <command> [options]

Commands:

  System Initialization:
    init [--skip-build]     - Initialize all projects (pnpm, python, etc.)
                            --skip-build: Skip build steps (faster setup)
    doctor                  - Check system status and dependencies

  Tmux Management:
    tmux start [type]       - Start tmux sessions
                             Types: desktop, mobile, both (default: both)
    tmux stop               - Stop all tmux sessions
    tmux list              - List all tmux sessions
    tmux attach <session>  - Attach to tmux session
    tmux kill <session>    - Kill specific tmux session
    tmux windows <session> - List windows in session
    tmux diagnose          - Diagnose all sessions (check for zombies)
    tmux cleanup           - Force cleanup all Univers sessions

  Univers Developer Management:
    dev restart [session]   - Restart univers-developer sessions
                             - No args: restart all univers-* sessions
                             - developer: restart univers-developer only
                             - core: restart core development sessions
                             - <session-name>: restart specific session
    dev start [session]     - Start univers-developer sessions
    dev stop [session]      - Stop univers-developer sessions
    dev status              - Show all univers-developer session status
    dev attach <session>    - Attach to specific univers-developer session
    dev list                - List all available univers-developer sessions

Resource Management:
    resource <command>       - Resource-centric management and automation
    resource discover        - Discover all available resources
    resource list [type]     - List resources by type
    resource info <id>       - Show detailed resource information
    resource start <id>      - Start a resource
    resource stop <id>       - Stop a resource
    resource monitor <type>  - Monitor system resources

  Agents Management:
    agents start            - Start univers-ark-agents service
    agents stop             - Stop univers-ark-agents service
    agents restart          - Restart univers-ark-agents service
    agents status           - Show univers-ark-agents service status
    agents logs [lines]     - Show univers-ark-agents logs (default: 50 lines)

  Help:
    help, --help, -h       - Show this help message
    version, --version     - Show version

Examples:
  cm init                              # Full initialization
  cm init --skip-build                # Fast initialization (no build)
  cm tmux start                        # Start both desktop and mobile views
  cm tmux start mobile                 # Start only mobile-view
  cm dev restart                       # Restart all univers-* sessions
  cm dev restart developer             # Restart univers-developer only
  cm dev restart core                  # Restart core development sessions
  cm dev restart univers-server        # Restart specific session
  cm dev status                        # Show all univers-developer session status
  cm dev attach univers-developer      # Attach to univers-developer session
  cm agents start                      # Start agents service
  cm agents status                     # Check agents service status
  cm doctor                            # Check system status

HELP
}

# Initialize all projects
# Configure shell environment for bash to find pnpm
configure_shell_env() {
    log_step "Configuring shell environment for pnpm..."
    
    local bashrc="$HOME/.bashrc"
    local path_config="export PATH=\$HOME/.local/bin:\$HOME/.npm-global/bin:\$PATH"
    
    # Check if PATH is already configured in .bashrc
    if ! grep -q ".local/bin" "$bashrc" 2>/dev/null; then
        log_info "Adding pnpm PATH to .bashrc..."
        echo "" >> "$bashrc"
        echo "# pnpm and npm global PATH" >> "$bashrc"
        echo "$path_config" >> "$bashrc"
        log_success "PATH configured in .bashrc"
    else
        log_info ".bashrc already has .local/bin in PATH"
    fi
    
    # Also ensure .bash_profile sources .bashrc
    local bash_profile="$HOME/.bash_profile"
    if [ ! -f "$bash_profile" ] || ! grep -q ".bashrc" "$bash_profile" 2>/dev/null; then
        log_info "Configuring .bash_profile to source .bashrc..."
        echo "" >> "$bash_profile"
        echo "# Source .bashrc" >> "$bash_profile"
        echo "if [ -f ~/.bashrc ]; then" >> "$bash_profile"
        echo "    . ~/.bashrc" >> "$bash_profile"
        echo "fi" >> "$bash_profile"
        log_success ".bash_profile configured"
    fi
}

init_projects() {
    local skip_build=false
    
    # Parse arguments
    while [ $# -gt 0 ]; do
        case "$1" in
            --skip-build)
                skip_build=true
                ;;
            *)
                log_error "Unknown option: $1"
                exit 1
                ;;
        esac
        shift
    done
    
    echo ""
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘         Container Project Initialization                  â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo ""
    
    # Configure shell environment (bash) for pnpm
    configure_shell_env
    
    # Initialize hvac-workbench (Node.js/pnpm)
    init_workbench "$skip_build"
    
    # Initialize hvac-operation (Python)
    init_operation
    
    # Initialize univers-container
    init_univers_container
    
    echo ""
    log_success "All projects initialized successfully!"
    echo ""
    echo "Next steps:"
    echo "  1. Start tmux sessions: cm tmux start"
    echo "  2. Run individual services: univers-developer, univers-server, etc."
    echo ""
}

# Initialize hvac-workbench
init_workbench() {
    local skip_build=$1
    
    local wb_path="/home/ubuntu/repos/hvac-workbench"
    
    if [ ! -d "$wb_path" ]; then
        log_warning "hvac-workbench not found at $wb_path"
        return
    fi
    
    echo ""
    log_step "Initializing hvac-workbench (Node.js/pnpm)..."
    
    if [ ! -f "$wb_path/package.json" ]; then
        log_warning "package.json not found in hvac-workbench"
        return
    fi
    
    cd "$wb_path"

    # Always run pnpm install to ensure dependencies are properly linked
    # This fixes broken symlinks in monorepo and ensures UI/Web services work correctly
    log_info "Installing/updating pnpm dependencies (with lockfile flexibility)..."
    pnpm install --no-frozen-lockfile || log_error "pnpm install failed"
    
    # Check if build tools are built
    if [ ! -d "$wb_path/packages/dev-tools/dist" ]; then
        log_info "Building dev-tools..."
        pnpm --filter @univers/dev-tools build || log_error "dev-tools build failed"
    else
        log_info "dev-tools already built"
    fi
    
    # Run setup command if not skipping build
    if [ "$skip_build" = false ]; then
        log_info "Running pnpm setup..."
        pnpm dev setup || log_warning "pnpm dev setup had issues but continuing..."
    fi
    
    log_success "hvac-workbench initialized"
}

# Initialize hvac-operation (Python)
init_operation() {
    local op_path="/home/ubuntu/repos/hvac-operation"
    
    if [ ! -d "$op_path" ]; then
        log_warning "hvac-operation not found at $op_path"
        return
    fi
    
    echo ""
    log_step "Initializing hvac-operation (Python)..."
    
    if [ ! -f "$op_path/requirements.txt" ]; then
        log_warning "requirements.txt not found in hvac-operation"
        return
    fi
    
    cd "$op_path"
    
    # Check if venv exists
    if [ ! -d "$op_path/.venv" ]; then
        log_info "Creating Python virtual environment..."
        python3 -m venv .venv || log_error "Failed to create venv"
    else
        log_info "Python virtual environment already exists"
    fi
    
    # Activate venv and install requirements
    log_info "Installing Python dependencies..."
    source "$op_path/.venv/bin/activate"
    pip install --upgrade pip || log_warning "pip upgrade had issues"
    pip install -r requirements.txt || log_error "pip install failed"
    deactivate
    
    log_success "hvac-operation initialized"
}

# Initialize univers-container
init_univers_container() {
    local uc_path="$HOME/repos/univers-container"
    
    if [ ! -d "$uc_path" ]; then
        log_warning "univers-container not found at $uc_path"
        return
    fi
    
    echo ""
    log_step "Checking univers-container..."
    
    # univers-container might not need initialization, just verify it exists
    log_success "univers-container verified"
}

# Check system dependencies
check_doctor() {
    echo ""
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘            System Dependency Check (Doctor)                â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo ""
    
    local issues=0
    
    # Check Node.js
    if command -v node &> /dev/null; then
        local node_version=$(node --version)
        log_success "Node.js: $node_version"
    else
        log_error "Node.js: NOT INSTALLED"
        issues=$((issues + 1))
    fi
    
    # Check pnpm
    if command -v pnpm &> /dev/null; then
        local pnpm_version=$(pnpm --version)
        log_success "pnpm: $pnpm_version"
    else
        log_error "pnpm: NOT INSTALLED"
        issues=$((issues + 1))
    fi
    
    # Check Python 3
    if command -v python3 &> /dev/null; then
        local python_version=$(python3 --version)
        log_success "Python 3: $python_version"
    else
        log_error "Python 3: NOT INSTALLED"
        issues=$((issues + 1))
    fi
    
    # Check Rust
    if command -v rustc &> /dev/null; then
        local rust_version=$(rustc --version)
        log_success "Rust: $rust_version"
    else
        log_warning "Rust: NOT INSTALLED (optional, needed for server compilation)"
    fi
    
    # Check Cargo
    if command -v cargo &> /dev/null; then
        local cargo_version=$(cargo --version)
        log_success "Cargo: $cargo_version"
    else
        log_warning "Cargo: NOT INSTALLED (optional, needed for server compilation)"
    fi
    
    # Check tmux
    if command -v tmux &> /dev/null; then
        local tmux_version=$(tmux -V)
        log_success "tmux: $tmux_version"
    else
        log_error "tmux: NOT INSTALLED"
        issues=$((issues + 1))
    fi
    
    # Check Git
    if command -v git &> /dev/null; then
        local git_version=$(git --version)
        log_success "Git: $git_version"
    else
        log_error "Git: NOT INSTALLED"
        issues=$((issues + 1))
    fi
    
    # Check projects
    echo ""
    log_info "Project paths:"
    
    local projects=(
        "/home/ubuntu/repos/hvac-workbench"
        "/home/ubuntu/repos/hvac-operation"
        "$HOME/repos/univers-container"
    )
    
    for project in "${projects[@]}"; do
        if [ -d "$project" ]; then
            log_success "$project"
        else
            log_error "$project: NOT FOUND"
            issues=$((issues + 1))
        fi
    done
    
    echo ""
    if [ $issues -eq 0 ]; then
        log_success "All essential dependencies installed âœ¨"
    else
        log_error "$issues issue(s) found - please install missing dependencies"
        return 1
    fi
}

# Main command dispatcher
main() {
    local cmd="${1:-help}"
    shift || true

    case "$cmd" in
        init)
            init_projects "$@"
            ;;
        doctor)
            check_doctor
            ;;
        tmux)
            tmux_command "$@"
            ;;
        dev)
            dev_command "$@"
            ;;
      resource)
            resource_command "$@"
            ;;
        agents)
            agents_command "$@"
            ;;
        help|--help|-h)
            print_help
            ;;
        version|--version)
            echo "Container Management Tool (cm) v2.1.0"
            ;;
        *)
            echo -e "${RED}Error: Unknown command '$cmd'${NC}"
            echo "Run 'cm help' for usage information"
            exit 1
            ;;
    esac
}

# Tmux management functions
tmux_command() {
    local subcmd="${1:-help}"
    shift || true

    case "$subcmd" in
        start)
            tmux_start "$@"
            ;;
        stop)
            tmux_stop_all
            ;;
        list)
            tmux_list
            ;;
        attach)
            tmux_attach "$1"
            ;;
        kill)
            tmux_kill "$1"
            ;;
        windows)
            tmux_windows "$1"
            ;;
        diagnose)
            tmux_diagnose
            ;;
        cleanup)
            tmux_cleanup
            ;;
        *)
            echo -e "${RED}Error: Unknown tmux command '$subcmd'${NC}"
            exit 1
            ;;
    esac
}

# Start tmux sessions with optional view type
tmux_start() {
    local view_type="${1:-both}"  # desktop, mobile, or both
    local tmux_manager="$HOME/repos/univers-container/.claude/skills/tmux-manage/scripts/tmux-manager.sh"
    
    if [ ! -f "$tmux_manager" ]; then
        echo -e "${RED}Error: tmux-manager.sh not found${NC}"
        exit 1
    fi
    
    # Validate view type
    case "$view_type" in
        desktop|mobile|both)
            bash "$tmux_manager" start "$view_type"
            ;;
        *)
            echo -e "${RED}Error: Unknown view type '$view_type'${NC}"
            echo "Valid types: desktop, mobile, both"
            exit 1
            ;;
    esac
}

# Stop all tmux sessions
tmux_stop_all() {
    local tmux_manager="$HOME/repos/univers-container/.claude/skills/tmux-manage/scripts/tmux-manager.sh"
    
    if [ ! -f "$tmux_manager" ]; then
        echo -e "${RED}Error: tmux-manager.sh not found${NC}"
        exit 1
    fi
    
    bash "$tmux_manager" stop-all
}

# List all tmux sessions
tmux_list() {
    echo -e "${BLUE}=== Tmux Sessions ===${NC}"
    if tmux list-sessions 2>/dev/null; then
        echo ""
        echo -e "${GREEN}Total: $(tmux list-sessions 2>/dev/null | wc -l) sessions${NC}"
    else
        echo -e "${YELLOW}No tmux sessions found${NC}"
    fi
}

# Attach to tmux session
tmux_attach() {
    local session="$1"
    
    if [ -z "$session" ]; then
        echo -e "${RED}Error: Session name required${NC}"
        exit 1
    fi
    
    if ! tmux has-session -t "$session" 2>/dev/null; then
        echo -e "${RED}Error: Session '$session' not found${NC}"
        exit 1
    fi
    
    tmux attach-session -t "$session"
}

# Kill specific tmux session
tmux_kill() {
    local session="$1"
    
    if [ -z "$session" ]; then
        echo -e "${RED}Error: Session name required${NC}"
        exit 1
    fi
    
    if tmux kill-session -t "$session" 2>/dev/null; then
        echo -e "${GREEN}âœ“ Session '$session' closed${NC}"
    else
        echo -e "${RED}Error: Session '$session' not found${NC}"
        exit 1
    fi
}

# List windows in a tmux session
tmux_windows() {
    local session="$1"

    if [ -z "$session" ]; then
        echo -e "${RED}Error: Session name required${NC}"
        exit 1
    fi

    echo -e "${BLUE}=== Windows in session '$session' ===${NC}"
    if tmux list-windows -t "$session" 2>/dev/null; then
        echo ""
    else
        echo -e "${RED}Error: Session '$session' not found${NC}"
        exit 1
    fi
}

# Diagnose sessions
tmux_diagnose() {
    local tmux_manager="/home/ubuntu/repos/univers-container/.claude/skills/tmux-manage/scripts/tmux-manager.sh"

    if [ ! -f "$tmux_manager" ]; then
        echo -e "${RED}Error: tmux-manager.sh not found${NC}"
        exit 1
    fi

    bash "$tmux_manager" diagnose
}

# Force cleanup sessions
tmux_cleanup() {
    local tmux_manager="/home/ubuntu/repos/univers-container/.claude/skills/tmux-manage/scripts/tmux-manager.sh"

    if [ ! -f "$tmux_manager" ]; then
        echo -e "${RED}Error: tmux-manager.sh not found${NC}"
        exit 1
    fi

    bash "$tmux_manager" cleanup
}

# Univers developer management functions
dev_command() {
    local subcmd="${1:-help}"
    shift || true

    case "$subcmd" in
        restart)
            dev_restart "$@"
            ;;
        start)
            dev_start "$@"
            ;;
        stop)
            dev_stop "$@"
            ;;
        status)
            dev_status
            ;;
        attach)
            dev_attach "$@"
            ;;
        list)
            dev_list
            ;;
        help|--help|-h)
            dev_help
            ;;
        *)
            echo -e "${RED}Error: Unknown dev command '$subcmd'${NC}"
            dev_help
            exit 1
            ;;
    esac
}

# Get the base path for univers-dev scripts
dev_get_base_path() {
    local current_user=$(whoami)
    local base_path="/home/$current_user/repos/hvac-workbench/.claude/skills/univers-dev/scripts"
    
    # Try different possible locations
    if [ -d "$base_path" ]; then
        echo "$base_path"
        return 0
    fi
    
    # Try alternative paths
    local alt_paths=(
        "/home/ubuntu/repos/hvac-workbench/.claude/skills/univers-dev/scripts"
        "$HOME/repos/hvac-workbench/.claude/skills/univers-dev/scripts"
        "./hvac-workbench/.claude/skills/univers-dev/scripts"
        "../hvac-workbench/.claude/skills/univers-dev/scripts"
    )
    
    for path in "${alt_paths[@]}"; do
        if [ -d "$path" ]; then
            echo "$path"
            return 0
        fi
    done
    
    echo -e "${RED}Error: univers-dev scripts directory not found${NC}"
    echo -e "${YELLOW}Searched locations:${NC}"
    echo "  $base_path"
    for path in "${alt_paths[@]}"; do
        echo "  $path"
    done
    exit 1
}

# Define all available univers sessions (compat Bash 3.2)
get_session_script() {
    local session_name="$1"
    case "$session_name" in
        developer)
            echo "tmux-developer.sh"
            ;;
        server)
            echo "tmux-server.sh"
            ;;
        ui)
            echo "tmux-ui.sh"
            ;;
        web)
            echo "tmux-web.sh"
            ;;
        desktop-dev)
            echo "tmux-desktop-dev.sh"
            ;;
        mobile-dev)
            echo "tmux-mobile-dev.sh"
            ;;
        *)
            echo ""
            ;;
    esac
}

# Define session categories (compat Bash 3.2)
get_session_category() {
    local category="$1"
    case "$category" in
        core)
            echo "server ui web"
            ;;
        dev-views)
            echo "desktop-dev mobile-dev"
            ;;
        all)
            echo "developer server ui web desktop-dev mobile-dev"
            ;;
        *)
            echo ""
            ;;
    esac
}

# Get session script path
dev_get_session_script() {
    local session_name="$1"
    local base_path=$(dev_get_base_path)
    local script_name="$(get_session_script "$session_name")"
    
    if [ -z "$script_name" ]; then
        echo -e "${RED}Error: Unknown session '$session_name'${NC}"
        echo -e "${YELLOW}Available sessions:${NC}"
        dev_list_sessions
        exit 1
    fi
    
    local script_path="$base_path/$script_name"
    if [ ! -f "$script_path" ]; then
        echo -e "${RED}Error: Script not found: $script_path${NC}"
        exit 1
    fi
    
    echo "$script_path"
}

# Check if session exists
session_exists() {
    local session_name="$1"
    tmux has-session -t "$session_name" 2>/dev/null
}

# Restart specific session
restart_session() {
    local session_name="$1"
    local script_path=$(dev_get_session_script "$session_name")
    
    echo ""
    echo -e "${CYAN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo -e "${CYAN}  ğŸ”„ Restarting $session_name Session${NC}"
    echo -e "${CYAN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    
    log_info "Restarting $session_name session..."
    bash "$script_path" restart
}

# Start specific session
start_session() {
    local session_name="$1"
    local script_path=$(dev_get_session_script "$session_name")
    
    echo ""
    echo -e "${CYAN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo -e "${CYAN}  ğŸš€ Starting $session_name Session${NC}"
    echo -e "${CYAN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    
    log_info "Starting $session_name session..."
    bash "$script_path" start
}

# Stop specific session
stop_session() {
    local session_name="$1"
    local script_path=$(dev_get_session_script "$session_name")
    
    echo ""
    echo -e "${CYAN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo -e "${CYAN}  ğŸ›‘ Stopping $session_name Session${NC}"
    echo -e "${CYAN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    
    log_info "Stopping $session_name session..."
    bash "$script_path" stop
}

# Attach to specific session
attach_session() {
    local session_name="$1"
    local script_path=$(dev_get_session_script "$session_name")
    
    echo ""
    echo -e "${CYAN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo -e "${CYAN}  ğŸ”— Connecting to $session_name Session${NC}"
    echo -e "${CYAN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    
    log_info "Attaching to $session_name session..."
    log_warning "Press Ctrl+B then D to detach (session continues running)"
    echo ""
    sleep 1
    
    bash "$script_path" attach
}

# Restart multiple sessions
restart_sessions() {
    local sessions="$1"
    
    for session in $sessions; do
        restart_session "$session"
        sleep 1
    done
}

# Start multiple sessions
start_sessions() {
    local sessions="$1"
    
    for session in $sessions; do
        start_session "$session"
        sleep 1
    done
}

# Stop multiple sessions
stop_sessions() {
    local sessions="$1"
    
    for session in $sessions; do
        stop_session "$session"
        sleep 1
    done
}

# Restart univers-developer sessions
dev_restart() {
    local target="${1:-all}"
    
    case "$target" in
        "all")
            echo ""
            echo -e "${CYAN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
            echo -e "${CYAN}  ğŸ”„ Restarting All Univers Sessions${NC}"
            echo -e "${CYAN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
            echo ""
            restart_sessions "$(get_session_category "all")"
            ;;
        "developer")
            restart_session "developer"
            ;;
        "core")
            echo ""
            echo -e "${CYAN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
            echo -e "${CYAN}  ğŸ”„ Restarting Core Development Sessions${NC}"
            echo -e "${CYAN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
            echo ""
            restart_sessions "$(get_session_category "core")"
            ;;
        "dev-views")
            echo ""
            echo -e "${CYAN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
            echo -e "${CYAN}  ğŸ”„ Restarting Development View Sessions${NC}"
            echo -e "${CYAN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
            echo ""
            restart_sessions "$(get_session_category "dev-views")"
            ;;
        *)
            # Specific session name
            if [[ -n "$(get_session_script "$target")" ]]; then
                restart_session "$target"
            else
                echo -e "${RED}Error: Unknown target '$target'${NC}"
                echo -e "${YELLOW}Use 'cm dev list' to see available sessions${NC}"
                echo -e "${YELLOW}Or use: all, developer, core, dev-views${NC}"
                exit 1
            fi
            ;;
    esac
}

# Start univers-developer sessions
dev_start() {
    local target="${1:-all}"
    
    case "$target" in
        "all")
            echo ""
            echo -e "${CYAN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
            echo -e "${CYAN}  ğŸš€ Starting All Univers Sessions${NC}"
            echo -e "${CYAN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
            echo ""
            start_sessions "$(get_session_category "all")"
            ;;
        "developer")
            start_session "developer"
            ;;
        "core")
            echo ""
            echo -e "${CYAN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
            echo -e "${CYAN}  ğŸš€ Starting Core Development Sessions${NC}"
            echo -e "${CYAN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
            echo ""
            start_sessions "$(get_session_category "core")"
            ;;
        "dev-views")
            echo ""
            echo -e "${CYAN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
            echo -e "${CYAN}  ğŸš€ Starting Development View Sessions${NC}"
            echo -e "${CYAN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
            echo ""
            start_sessions "$(get_session_category "dev-views")"
            ;;
        *)
            # Specific session name
            if [[ -n "$(get_session_script "$target")" ]]; then
                start_session "$target"
            else
                echo -e "${RED}Error: Unknown target '$target'${NC}"
                echo -e "${YELLOW}Use 'cm dev list' to see available sessions${NC}"
                echo -e "${YELLOW}Or use: all, developer, core, dev-views${NC}"
                exit 1
            fi
            ;;
    esac
}

# Stop univers-developer sessions
dev_stop() {
    local target="${1:-all}"
    
    case "$target" in
        "all")
            echo ""
            echo -e "${CYAN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
            echo -e "${CYAN}  ğŸ›‘ Stopping All Univers Sessions${NC}"
            echo -e "${CYAN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
            echo ""
            stop_sessions "$(get_session_category "all")"
            ;;
        "developer")
            stop_session "developer"
            ;;
        "core")
            echo ""
            echo -e "${CYAN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
            echo -e "${CYAN}  ğŸ›‘ Stopping Core Development Sessions${NC}"
            echo -e "${CYAN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
            echo ""
            stop_sessions "$(get_session_category "core")"
            ;;
        "dev-views")
            echo ""
            echo -e "${CYAN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
            echo -e "${CYAN}  ğŸ›‘ Stopping Development View Sessions${NC}"
            echo -e "${CYAN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
            echo ""
            stop_sessions "$(get_session_category "dev-views")"
            ;;
        *)
            # Specific session name
            if [[ -n "$(get_session_script "$target")" ]]; then
                stop_session "$target"
            else
                echo -e "${RED}Error: Unknown target '$target'${NC}"
                echo -e "${YELLOW}Use 'cm dev list' to see available sessions${NC}"
                echo -e "${YELLOW}Or use: all, developer, core, dev-views${NC}"
                exit 1
            fi
            ;;
    esac
}

# Show univers-developer session status
dev_status() {
    local base_path=$(dev_get_base_path)
    
    echo ""
    echo -e "${CYAN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo -e "${CYAN}  ğŸ“Š Univers Developer Session Status${NC}"
    echo -e "${CYAN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    
    # Show categorized status
    echo -e "${MAGENTA}Core Development Sessions:${NC}"
    for session in $(get_session_category "core"); do
        if session_exists "univers-$session"; then
            echo -e "  ${GREEN}âœ… univers-$session${NC} - Running"
        else
            echo -e "  ${RED}âŒ univers-$session${NC} - Stopped"
        fi
    done
    
    echo ""
    echo -e "${BLUE}Development View Sessions:${NC}"
    for session in $(get_session_category "dev-views"); do
        if session_exists "univers-$session"; then
            echo -e "  ${GREEN}âœ… univers-$session${NC} - Running"
        else
            echo -e "  ${RED}âŒ univers-$session${NC} - Stopped"
        fi
    done
    
    echo ""
    echo -e "${CYAN}Developer Session:${NC}"
    if session_exists "univers-developer"; then
        echo -e "  ${GREEN}âœ… univers-developer${NC} - Running"
    else
        echo -e "  ${RED}âŒ univers-developer${NC} - Stopped"
    fi
    
    echo ""
    echo -e "${YELLOW}Usage Tips:${NC}"
    echo "  - Use 'cm dev restart' to restart all sessions"
    echo "  - Use 'cm dev restart core' for core sessions only"
    echo "  - Use 'cm dev attach <session>' to connect to specific session"
    echo "  - Use 'cm dev list' to see all available sessions"
}

# List all available sessions
dev_list() {
    echo ""
    echo -e "${CYAN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo -e "${CYAN}  ğŸ“‹ Available Univers Sessions${NC}"
    echo -e "${CYAN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    
    echo -e "${MAGENTA}Core Development Sessions:${NC}"
    for session in $(get_session_category "core"); do
        echo "  - univers-$session"
    done
    
    echo ""
    echo -e "${BLUE}Development View Sessions:${NC}"
    for session in $(get_session_category "dev-views"); do
        echo "  - univers-$session"
    done
    
    echo ""
    echo -e "${CYAN}Developer Session:${NC}"
    echo "  - univers-developer"
    
    echo ""
    echo -e "${YELLOW}Special Groups:${NC}"
    echo "  - all (restart all sessions)"
    echo "  - core (server, ui, web, claude)"
    echo "  - dev-views (desktop-dev, mobile-dev)"
    echo "  - developer (univers-developer only)"
    
    echo ""
    echo -e "${GREEN}Examples:${NC}"
    echo "  cm dev restart           # Restart all sessions"
    echo "  cm dev restart core      # Restart core sessions"
    echo "  cm dev restart server    # Restart univers-server"
    echo "  cm dev attach ui         # Attach to univers-ui"
}

# Attach to univers-developer session
dev_attach() {
    local session_name="${1:-developer}"
    
    # Handle the special case where user might just type 'cm dev attach'
    if [[ "$session_name" == "developer" ]] || [[ -z "$session_name" ]]; then
        attach_session "developer"
    else
        attach_session "$session_name"
    fi
}

# Show dev command help
dev_help() {
    cat << 'DEV_HELP'

 Univers Developer Session Management

 Usage: cm dev <command> [target/session]

 Commands:
   restart [target]    Restart univers-developer sessions
                       - No args: restart all univers-* sessions
                       - developer: restart univers-developer only
                       - core: restart core development sessions
                       - <session-name>: restart specific session
   start [target]      Start univers-developer sessions
                       - Same targets as restart
   stop [target]       Stop univers-developer sessions
                       - Same targets as restart
   status              Show all univers-developer session status
   attach [session]    Attach to specific univers-developer session
                       - Default: attach to univers-developer
   list                List all available univers-developer sessions

 Available Sessions:
   univers-server      - Backend API server (HTTP + Socket mode)
   univers-ui          - Storybook UI development
   univers-web         - Vite Web development server
   univers-desktop-dev - Desktop development aggregate view
   univers-mobile-dev  - Mobile development aggregate view
   univers-developer   - Developer terminal session

 Special Groups:
   all                 - All sessions (default)
   core                - Core development sessions (server, ui, web)
   dev-views           - Development view sessions (desktop-dev, mobile-dev)
   developer           - Developer terminal only

 Examples:
   cm dev restart           # Restart all sessions
   cm dev restart core      # Restart core development sessions
   cm dev restart server    # Restart univers-server only
   cm dev status            # Show status of all sessions
   cm dev attach ui         # Attach to univers-ui session
   cm dev list              # List all available sessions

 Tmux Navigation:
   Ctrl+B D        - Detach from session (session continues running)
   Ctrl+B [        - Enter scroll mode (press q to exit)
   Ctrl+B ?        - Show all tmux shortcuts

DEV_HELP
}

# Resource management functions
resource_command() {
    local subcmd="${1:-help}"
    shift || true

    # Get resource script path
    local resource_script="/home/ubuntu/repos/univers-container/.claude/skills/alerting/bin/resource"

    if [ ! -f "$resource_script" ]; then
        echo -e "${RED}Error: Resource manager not found${NC}"
        echo "Please ensure the alerting skill is properly installed."
        return 1
    fi

    case "$subcmd" in
        "init"|"discover"|"list"|"info"|"start"|"stop"|"restart"|"monitor"|"cleanup"|"attach"|"detach"|"kill"|"status"|"policies")
            # Forward to resource manager
            "$resource_script" "$subcmd" "$@"
            ;;
        "help"|"--help"|"-h")
            cat << 'RESOURCE_HELP'
Resource Management

 Usage: cm resource <command> [options]

 Discovery and Status:
     discover                  Discover all available resources
     list [type]              List resources (filter by type: cpu, memory, disk, univers_service, tmux_session)
     info <resource_id>       Show detailed resource information
     policies                 Show configured management policies

 Resource Actions:
     start <resource_id>      Start a resource (services)
     stop <resource_id>       Stop a resource (services)
     restart <resource_id>    Restart a resource (services)
     status <resource_id>     Check resource status (services)

     attach <resource_id>     Attach to tmux session
     detach <resource_id>     Detach from tmux session
     kill <resource_id>       Kill tmux session

     monitor <resource_type>  Monitor system resources (cpu, memory, disk)
     cleanup <resource_type>  Clean up system resources (memory, disk)

 Resource IDs format:
     - cpu:system
     - memory:system
     - disk:root
     - univers_service:<name>
     - tmux_session:<name>

 Examples:
     cm resource discover                           # Find all resources
     cm resource list univers_service              # List Univers services
     cm resource start univers_service:univers-server  # Start service
     cm resource attach tmux_session:univers-developer  # Connect to session
     cm resource monitor memory                    # Monitor memory usage

RESOURCE_HELP
            ;;
        *)
            echo -e "${RED}Error: Unknown resource command '$subcmd'${NC}"
            echo "Run 'cm resource help' for usage information"
            return 1
            ;;
    esac
}

# Agents management functions
agents_command() {
    local subcmd="${1:-help}"
    shift || true

    case "$subcmd" in
        start)
            agents_start "$@"
            ;;
        stop)
            agents_stop
            ;;
        restart)
            agents_restart "$@"
            ;;
        status)
            agents_status
            ;;
        logs)
            agents_logs "$@"
            ;;
        attach)
            agents_attach
            ;;
        help|--help|-h)
            agents_help
            ;;
        *)
            echo -e "${RED}Error: Unknown agents command '$subcmd'${NC}"
            agents_help
            exit 1
            ;;
    esac
}

# Agents tmux script
AGENTS_SCRIPT="$HOME/repos/univers-container/.claude/skills/univers-core/ops/tmux-agents.sh"

# Agents command handler - delegate to tmux script
agents_start() {
    local mode="${1:-dev}"
    if [ ! -f "$AGENTS_SCRIPT" ]; then
        log_error "Agents script not found: $AGENTS_SCRIPT"
        exit 1
    fi
    exec "$AGENTS_SCRIPT" start "$mode"
}

agents_stop() {
    if [ ! -f "$AGENTS_SCRIPT" ]; then
        log_error "Agents script not found: $AGENTS_SCRIPT"
        exit 1
    fi
    exec "$AGENTS_SCRIPT" stop
}

agents_restart() {
    local mode="${1:-dev}"
    if [ ! -f "$AGENTS_SCRIPT" ]; then
        log_error "Agents script not found: $AGENTS_SCRIPT"
        exit 1
    fi
    exec "$AGENTS_SCRIPT" restart "$mode"
}

agents_status() {
    if [ ! -f "$AGENTS_SCRIPT" ]; then
        log_error "Agents script not found: $AGENTS_SCRIPT"
        exit 1
    fi
    exec "$AGENTS_SCRIPT" status
}

agents_logs() {
    local lines="${1:-50}"
    if [ ! -f "$AGENTS_SCRIPT" ]; then
        log_error "Agents script not found: $AGENTS_SCRIPT"
        exit 1
    fi
    exec "$AGENTS_SCRIPT" logs "$lines"
}

agents_attach() {
    if [ ! -f "$AGENTS_SCRIPT" ]; then
        log_error "Agents script not found: $AGENTS_SCRIPT"
        exit 1
    fi
    exec "$AGENTS_SCRIPT" attach
}

# Show agents help
agents_help() {
    cat << 'AGENTS_HELP'

 Univers Ark Agents Management (tmux)

 Usage: cm agents <command> [options]

 Commands:
   start [mode]        Start univers-ark-agents service
                       Modes: dev (default), serve, prod, build
   stop                Stop univers-ark-agents service
   restart [mode]      Restart univers-ark-agents service
   status              Show univers-ark-agents service status
   logs [lines]        Show univers-ark-agents logs (default: 50 lines)
   attach              Attach to agents tmux session
   help                Show this help message

 Examples:
   cm agents start           # Start in dev mode
   cm agents start serve     # Start in serve mode
   cm agents stop            # Stop the agents service
   cm agents restart         # Restart the agents service
   cm agents status          # Check service status
   cm agents logs            # Show last 50 lines of logs
   cm agents logs 100        # Show last 100 lines of logs

 Notes:
   - Uses tmux for session management
   - Press Ctrl+B then D to detach from session

AGENTS_HELP
}

# Run main function
main "$@"
